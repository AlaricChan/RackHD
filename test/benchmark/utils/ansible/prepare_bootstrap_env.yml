---
- hosts: rackhd
  tasks:
    - name: check whether RackHD config file exists
      stat: path=/opt/monorail/config.json
      register: config_stat

    - name: Rename as backup file if any
      command: mv /opt/monorail/config.json /opt/monorail/config.json.bmbak
      sudo: yes
      when: config_stat.stat.exists

    - name: Copy config file to RackHD for image proxy
      template: src=files/config.json dest=/opt/monorail/config.json
      sudo: yes
      with_items:
          image_server

    - name: Restart RackHD services
      service: name={{ item }} state=restarted
      sudo: yes
      with_items:
          - isc-dhcp-server
          - on-dhcp-proxy
          - on-http
          - on-tftp
          - on-syslog
          - on-taskgraph

    - name: Wait until RackHD API is available
      action: shell curl http://localhost:8080/api/common/nodes
      register: result
      until: result.rc == 0
      retries: 10
      delay: 1
