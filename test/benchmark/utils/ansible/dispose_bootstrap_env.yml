---
- hosts: rackhd
  tasks:
    - name: check whether RackHD config backup file exists
      stat: path=/opt/monorail/config.json.bmbak
      register: bak_stat

    - name: Restore backup file if any
      command: mv /opt/monorail/config.json.bmbak /opt/monorail/config.json
      sudo: yes
      when: bak_stat.stat.exists

    - name: Else remove config file for benchmark
      command: rm /opt/monorail/config.json
      sudo: yes
      when: bak_stat.stat.exists == false

    - name: Restart RackHD services
      service: name={{ item }} state=restarted
      sudo: yes
      with_items:
          - isc-dhcp-server
          - on-dhcp-proxy
          - on-http
          - on-tftp
          - on-syslog
          - on-taskgraph

    - name: Wait until RackHD API is available
      action: shell curl http://localhost:8080/api/common/nodes
      register: result
      until: result.rc == 0
      retries: 10
      delay: 1
